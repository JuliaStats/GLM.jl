rng = StableRNG(123)

x1 = rand(rng, 25)
x2 = ifelse.(randn(rng, 25) .> 0, 1, 0)
y = ifelse.(0.004 .- 0.01 .* x1 .+ 1.5 .* x2 .+ randn(rng, 25) .> 0, 1, 0)
w = rand(rng, 25) * 6
w = floor.(w) .+ 1
df = DataFrame(y=y, x1=x1, x2=x2, w=w)

clotting = DataFrame(u=log.([5, 10, 15, 20, 30, 40, 60, 80, 100]),
                     lot1=[118, 58, 42, 35, 27, 25, 21, 19, 18],
                     w=[1.5, 2.0, 1.1, 4.5, 2.4, 3.5, 5.6, 5.4, 6.7])

quine.aweights = log.(3 .+ 3 .* quine.Days)
quine.pweights = 1.0 ./ (quine.aweights ./ sum(quine.aweights))
quine.fweights = floor.(quine.aweights)

dobson = DataFrame(Counts=[18.0, 17, 15, 20, 10, 20, 25, 13, 12],
                   Outcome=categorical(repeat(string.('A':'C'), outer=3)),
                   Treatment=categorical(repeat(string.('a':'c'), inner=3)),
                   w=[1, 2, 1, 2, 3, 4, 3, 2, 1])

itr = Iterators.product((:qr, :cholesky), (true, false))

@testset "Linear model ftest with $dmethod method with dropcollinear=$drop" for (dmethod,
                                                                                 drop) in
                                                                                itr

    model_0 = lm(@formula(y ~ x1), df; wts=aweights(df.w), method=dmethod,
                 dropcollinear=drop)
    model_1 = lm(@formula(y ~ x1 + x2), df; wts=aweights(df.w),
                 method=dmethod, dropcollinear=drop)
    X = hcat(ones(length(df.y)), df.x1, df.x2)
    model_2 = lm(X, y; wts=aweights(df.w), method=dmethod, dropcollinear=drop)
    @test ftest(model_1).fstat ≈ 1.551275 rtol = 1e-05
    @test ftest(model_2) === ftest(model_1)
    @test ftest(model_0, model_1).fstat[2] ≈ 1.7860438 rtol = 1e-05
    @test ftest(model_0, model_2).fstat[2] ≈ 1.7860438 rtol = 1e-05
end

@testset "GLM: Binomial with LogitLink link - AnalyticWeights with $dmethod method" for (dmethod,
                                                                                         drop) in
                                                                                        itr

    model = glm(@formula(y ~ 1 + x1 + x2), df, Binomial(), LogitLink(), wts=aweights(df.w),
                method=dmethod, dropcollinear=drop, atol=1e-08, rtol=1e-08)
    @test deviance(model) ≈ 39.58120350785813 rtol = 1e-06
    @test coef(model) ≈ [0.6333582770515337, 1.8861277804531265, 18.61281712203539] rtol = 1e-06
    @test stderror(model) ≈ [0.9021013750843575, 2.063002891039618, 2337.217357530545] rtol = 1e-07
    @test_throws ArgumentError loglikelihood(model)
    @test_throws ArgumentError nullloglikelihood(model)
    @test_throws ArgumentError aic(model)
    @test_throws ArgumentError bic(model)
    @test cooksdistance(model) ≈ [2.672806e-01; 2.516262e-02; 1.367146e-01; 3.382852e-02;
                                  3.708084e-10; 2.144406e-02; 2.290360e-01; 2.113025e-02; 9.451432e-03;
                                  2.145286e-03; 3.021442e-10; 2.085282e-10; 3.571678e-12; 2.593863e-11;
                                  1.727869e-10; 3.657217e-10; 7.122122e-02; 6.682159e-02; 2.762688e+00;
                                  2.051375e-01; 9.093471e-10; 2.544133e-10; 2.780846e-10; 2.258433e-10;
                                  3.242331e-02] rtol = 1e-04
    @test GLM.momentmatrix(model) ≈ [1.095702695280752 0.1983501744547734 0.0;
                                     0.6292210259386299 0.2312324009639611 0.0;
                                     -0.869357286789858 -0.5816508224007081 -0.0;
                                     0.3287258318630744 0.0140466407925222 0.0;
                                     2.08484144507e-8 9.1314170785019e-9 2.085e-8;
                                     0.5274699949608909 0.2549210423027525 0.0;
                                     -0.8883810924640739 -0.678699816121261 -0.0;
                                     0.169878909537636 0.15705018022658265 0.0;
                                     0.3346238606654708 0.1723463870596023 0.0;
                                     0.17263445723951362 0.085461258206114 0.0;
                                     1.90303118479143e-8 1.3346718776025414e-8 1.90e-8;
                                     1.60927355387381e-8 1.1161427644959331e-8 1.61e-8;
                                     2.2803477805569965e-9 1.9982067289774133e-9 2.28e-9;
                                     6.018177387787048e-9 5.682479294453922e-9 6.02e-9;
                                     1.4765287153134531e-8 1.0914686191045351e-8 1.48e-8;
                                     2.0721163707495327e-8 1.1594416669570361e-8 2.07e-8;
                                     0.8473483434776684 0.4295002258959193 0.0;
                                     0.5426271690329769 0.35055009398999054 0.0;
                                     -4.541414638754089 -1.2097095921684677 -0.0;
                                     1.2385948537889822 0.31353946330992544 0.0;
                                     3.067144219729067e-8 1.078462894246146e-8 3.07e-8;
                                     1.7613428517425065e-8 9.289130102493344e-9 1.76e-8;
                                     1.8334365002191494e-8 1.3220774075528698e-8 1.83e-8;
                                     1.6687848932140258e-8 3.1458514759844027e-9 1.67e-8;
                                     0.4123258762224241 0.2630623634882926 0.0] rtol = 1e-07
end

@testset "GLM: Binomial with ProbitLink link - AnalyticWeights with $dmethod method" for (dmethod,
                                                                                          drop) in
                                                                                         itr

    model = glm(@formula(y ~ 1 + x1 + x2), df, Binomial(), ProbitLink(),
                wts=aweights(df.w), method=dmethod, dropcollinear=drop, rtol=1e-09)
    @test deviance(model) ≈ 39.595360462143866 rtol = 1e-06
    @test coef(model) ≈ [0.42120722997197313, 1.0416447141541567, 4.916910225354065] rtol = 1e-07
    @test stderror(model) ≈ [0.5216506352923727, 1.1455457218079563, 325.2782732702344] rtol = 1e-07
    @test_throws ArgumentError loglikelihood(model)
    @test_throws ArgumentError nullloglikelihood(model)
    @test_throws ArgumentError aic(model)
    @test_throws ArgumentError bic(model)
    @test GLM.momentmatrix(model) ≈ [1.8176341588673794 0.32903820904987535 0.0;
                                     1.0975399310212473 0.40333489019264895 0.0;
                                     -1.6205390909958874 -1.0842353418245372 -0.0;
                                     0.5269343763678408 0.02251620404797942 0.0;
                                     2.1411260807372573e-7 9.377938695085409e-8 2.14e-7;
                                     0.9490575664910063 0.45867015444762754 0.0;
                                     -1.7015508605205314 -1.2999401562600912 -0.0;
                                     0.33388087355781 0.3086672236664311 0.0;
                                     0.6070565699014323 0.31266152495891864 0.0;
                                     0.3115689943654785 0.15423965008066182 0.0;
                                     6.62696579317951e-8 4.647756142241091e-8 6.63e-8;
                                     5.7919749595281985e-8 4.0171361342870654e-8 5.79e-8;
                                     3.7134640590626956e-9 3.2540075395089014e-9 3.71e-9;
                                     7.229998935730756e-9 6.826704599068171e-9 7.23e-9;
                                     4.373923181354305e-8 3.233259092972413e-8 4.37e-8;
                                     1.3039185369174096e-7 7.296006649823636e-8 1.30e-7;
                                     1.5339832954887218 0.7775387501543354 0.0;
                                     1.016200760890786 0.6564899300523522 0.0;
                                     -7.736929921295398 -2.060908127581581 -0.0;
                                     2.0943898311662204 0.5301764831468441 0.0;
                                     4.4180333118496e-7 1.553459717259102e-7 4.42e-7;
                                     1.2636718773015955e-7 6.664467660855266e-8 1.26e-7;
                                     5.869289625690482e-8 4.232301043195289e-8 5.86e-8;
                                     4.453972209837739e-7 8.396249934481249e-8 4.45e-7;
                                     0.7707735136764122 0.49175061259680825 0.0] rtol = 1e-07
end

@testset "GLM: Binomial with CauchitLink link - AnalyticWeights - method $dmethod" for (dmethod,
                                                                                        drop) in
                                                                                       itr

    model = glm(@formula(y ~ 1 + x1 + x2), df, Binomial(), CauchitLink(),
                wts=aweights(df.w),
                method=dmethod, dropcollinear=drop, rtol=1e-08, atol=1e-08)
    @test deviance(model) ≈ 39.627559015619845 rtol = 1e-07
    @test_throws ArgumentError loglikelihood(model)
    @test_throws ArgumentError nullloglikelihood(model)
    @test_throws ArgumentError aic(model)
    @test_throws ArgumentError bic(model)
    @test GLM.momentmatrix(model) ≈ [1.003054020887253 0.1815783979426737 0.0;
                                     0.4264622162277366 0.15672057689370572 0.0;
                                     -0.41221991029044563 -0.27579920646405165 -0.0;
                                     0.39009720364187195 0.016669074233287458 0.0;
                                     0.0 0.0 0.0;
                                     0.311923278855423 0.15074944190941555 0.0;
                                     -0.37849361968132017 -0.28915918208960645 -0.0;
                                     0.08167834727345773 0.07551025135974303 0.0;
                                     0.1919243490466221 0.0988496997230555 0.0;
                                     0.10090666946769812 0.049953010957329104 0.0;
                                     0.0 0.0 0.0;
                                     0.0 0.0 0.0;
                                     0.0 0.0 0.0;
                                     0.0 0.0 0.0;
                                     0.0 0.0 0.0;
                                     0.0 0.0 0.0;
                                     0.4897032828746528 0.2482186602895976 0.0;
                                     0.28232074585439737 0.18238593576314036 0.0;
                                     -3.7015013060867705 -0.985979478109429 -0.0;
                                     0.9986020018483154 0.25278737010890295 0.0;
                                     0.0 0.0 0.0;
                                     0.0 0.0 0.0;
                                     0.0 0.0 0.0;
                                     0.0 4.7109001281144596e-17 0.0;
                                     0.21554272008110664 0.1375154474822352 0.0] rtol = 1e-07
end

@testset "GLM: Binomial with CloglogLink link - AnalyticWeights with $dmethod method" for (dmethod,
                                                                                           drop) in
                                                                                          itr

    model = glm(@formula(y ~ 1 + x1 + x2), df, Binomial(), CloglogLink(),
                wts=aweights(df.w),
                method=dmethod, dropcollinear=drop, rtol=5e-10, atol=1e-10)
    @test deviance(model) ≈ 39.61484762863061 rtol = 1e-07
    @test coef(model) ≈ [0.12095167614339054, 0.8666201161364425, 2.71457411130009] rtol = 1e-07
    @test stderror(model) ≈ [0.46442064138194333, 0.9661962332997427, 462.67067410332123] rtol = 1e-07
    @test_throws ArgumentError loglikelihood(model)
    @test_throws ArgumentError nullloglikelihood(model)
    @test_throws ArgumentError aic(model)
    @test_throws ArgumentError bic(model)
    @test GLM.momentmatrix(model) ≈ [1.9242952153533148 0.3483465846271526 0.0;
                                     1.2514530854268051 0.45989642702311906 0.0;
                                     -2.0153062620933504 -1.348357645985017 -0.0;
                                     0.5261952160086218 0.02248461930760421 0.0;
                                     1.5917320997016487e-7 6.971642718424943e-8 1.5e-7;
                                     1.1286597324859617 0.5454701085543264 0.0;
                                     -2.188084897309478 -1.6716393787069568 -0.0;
                                     0.44263603677181956 0.4092095336554625 0.0;
                                     0.7298024393361812 0.3758811862272388 0.0;
                                     0.37203439025955143 0.1841725435114846 0.0;
                                     1.79124103038821e-9 1.2562689715087133e-9 0.0;
                                     1.7546756596715808e-9 1.216989204144432e-9 0.0;
                                     5.7157964501561416e-12 5.00859694540867e-12 0.0;
                                     3.1204806380028555e-12 2.9464180717205265e-12 0.0;
                                     6.677005273849182e-10 4.93572637661486e-10 6.7e-10;
                                     2.403535247525871e-8 1.3448853323683519e-8 2.4e-8;
                                     1.839078160139044 0.9321839020515984 0.0;
                                     1.2724386238625014 0.8220257013418844 0.0;
                                     -8.529708800751662 -2.2720829026754306 -0.0;
                                     2.2835873542705203 0.5780701827470168 0.0;
                                     7.796454326518419e-7 2.7413731130574843e-7 7.79e-7;
                                     3.441301868580375e-8 1.8149050735676883e-8 3.44e-8;
                                     1.181434863206281e-9 8.519238822580661e-10 1.18e-9;
                                     3.115862778487023e-6 5.873759740112369e-7 3.11e-6;
                                     0.9629196988432743 0.6143391585021523 0.0] rtol = 1e-05
end

@testset "GLM: Gamma with InverseLink link - AnalyticWeights with $dmethod method" for (dmethod,
                                                                                        drop) in
                                                                                       itr

    model = glm(@formula(lot1 ~ 1 + u), clotting, Gamma(), InverseLink(),
                wts=aweights(clotting.w), method=dmethod, dropcollinear=drop, atol=1e-07,
                rtol=1e-08)
    @test deviance(model) ≈ 0.03933389380881642 rtol = 1e-07
    @test loglikelihood(model) ≈ -43.359078787690514 rtol = 1e-07
    @test coef(model) ≈ [-0.017217012596343607, 0.015649040406186487] rtol = 1e-07
    @test stderror(model) ≈ [0.0009144223353860925, 0.0003450913537314497] rtol = 1e-04
    @test aic(model) ≈ 92.71815757538103 rtol = 1e-07
    @test bic(model) ≈ 93.30983130738969 rtol = 1e-07
    @test GLM.momentmatrix(model) ≈ [1900.1063511093867 3058.103199132267;
                                     -1643.317155973023 -3783.877586404854;
                                     -420.13783432322964 -1137.7543467296691;
                                     -981.2887166533023 -2939.6782781526754;
                                     313.30087123532877 1065.5981029180723;
                                     -186.60227446859759 -688.353296378139;
                                     324.34628373045786 1327.9854430687467;
                                     430.8197010892654 1887.863404915401;
                                     262.77277766267576 1210.113361381432] rtol = 1e-07
end

@testset "GLM: Gamma with IdentityLink link - AnalyticWeights with $dmethod method" for (dmethod,
                                                                                         drop) in
                                                                                        itr

    model = glm(@formula(lot1 ~ 1 + u), clotting, Gamma(), IdentityLink(),
                wts=aweights(clotting.w), method=dmethod, dropcollinear=drop,
                rtol=1e-10, atol=1e-10, minstepfac=0.00001)
    @test deviance(model) ≈ 1.3435348802929383 rtol = 1e-07
    @test loglikelihood(model) ≈ -101.19916126647321 rtol = 1e-07
    @test coef(model) ≈ [86.45700434128152, -15.320695650698417] rtol = 1e-05
    @test stderror(model) ≈ [16.07962739541372, 3.766841480457265] rtol = 1e-05
    @test GLM.aic(model) ≈ 208.39832253294642 rtol = 1e-07
    @test GLM.bic(model) ≈ 208.9899962649551 rtol = 1e-07
    @test GLM.momentmatrix(model) ≈ [0.26061914480947884 0.4194503323625281;
                                     0.06148544891860896 0.14157547811603585;
                                     -0.019061929106842457 -0.051620660951180786;
                                     -0.1795782998461795 -0.5379685084791557;
                                     -0.1764962075232437 -0.6002984389013568;
                                     -0.2277661940139623 -0.8402020334398342;
                                     -0.3204523427685144 -1.3120423070655995;
                                     -0.054878647210950426 -0.2404796937532563;
                                     0.6561290267416002 3.0215858321118008] rtol = 1e-04
end

@testset "GLM: Gamma with LogLink link - AnalyticWeights with $dmethod method" for (dmethod,
                                                                                    drop) in
                                                                                   itr

    model = glm(@formula(lot1 ~ 1 + u), clotting, Gamma(), LogLink(),
                wts=aweights(clotting.w), method=dmethod, dropcollinear=drop, atol=1e-09,
                rtol=1e-09)
    @test deviance(model) ≈ 0.41206342934199663 rtol = 1e-07
    @test loglikelihood(model) ≈ -81.79777246247532 rtol = 1e-07
    @test coef(model) ≈ [5.325107090308856, -0.5495682740033511] rtol = 1e-07
    @test stderror(model) ≈ [0.20287310816341905, 0.053062600599660774] rtol = 1e-07
    @test GLM.aic(model) ≈ 169.59554492495064 rtol = 1e-07
    @test GLM.bic(model) ≈ 170.18721865695932 rtol = 1e-07
    @test GLM.momentmatrix(model) ≈ [14.39716447431257 23.171342336508012;
                                     0.0374983950207553 0.0863432453859933;
                                     -2.5490869750808054 -6.903055495494598;
                                     -12.821435846444906 -38.40958915849704;
                                     -8.713283462827741 -29.635596899449876;
                                     -6.520303896525519 -24.05261507847203;
                                     -4.123729229896082 -16.88396834850135;
                                     3.70269025008355 16.225287295813413;
                                     16.590486289982852 76.40201283367323] rtol = 1e-07
end

@testset "GLM: Gamma with InverseLink link - AnalyticWeights with $dmethod method" for (dmethod,
                                                                                        drop) in
                                                                                       itr

    model = glm(@formula(lot1 ~ 1 + u), clotting, Gamma(), InverseLink(),
                wts=aweights(clotting.w), method=dmethod, dropcollinear=drop, atol=1e-09,
                rtol=1e-09)
    @test deviance(model) ≈ 0.03933389380881642 rtol = 1e-07
    @test loglikelihood(model) ≈ -43.359078787690514 rtol = 1e-07
    @test coef(model) ≈ [-0.017217012596343607, 0.015649040406186487] rtol = 1e-07
    @test stderror(model) ≈ [0.0009144223353860925, 0.0003450913537314497] rtol = 1e-07
    @test GLM.aic(model) ≈ 92.71815757538103 rtol = 1e-07
    @test GLM.bic(model) ≈ 93.30983130738969 rtol = 1e-07
    @test GLM.momentmatrix(model) ≈ [1900.1063511093867 3058.103199132267;
                                     -1643.317155973023 -3783.877586404854;
                                     -420.13783432322964 -1137.7543467296691;
                                     -981.2887166533023 -2939.6782781526754;
                                     313.30087123532877 1065.5981029180723;
                                     -186.60227446859759 -688.353296378139;
                                     324.34628373045786 1327.9854430687467;
                                     430.8197010892654 1887.863404915401;
                                     262.77277766267576 1210.113361381432] rtol = 1e-07
end

@testset "GLM: InverseGaussian with InverseSquareLink link - AnalyticWeights with $dmethod method" for (dmethod,
                                                                                                        drop) in
                                                                                                       itr

    model = glm(@formula(lot1 ~ 1 + u), clotting, InverseGaussian(), InverseSquareLink(),
                wts=aweights(clotting.w), method=dmethod, dropcollinear=drop, atol=1e-09,
                rtol=1e-09)
    @test deviance(model) ≈ 0.021377370485120707 rtol = 1e-07
    @test loglikelihood(model) ≈ -86.82546665077861 rtol = 1e-07
    @test coef(model) ≈ [-0.0012633718975150973, 0.0008126490405747128] rtol = 1e-07
    @test stderror(model) ≈ [0.00016779409928094252, 9.025235597677238e-5] rtol = 1e-07
    @test GLM.aic(model) ≈ 179.65093330155722 rtol = 1e-07
    @test GLM.bic(model) ≈ 180.2426070335659 rtol = 1e-07
    @test GLM.momentmatrix(model) ≈ [28815.030725087538 46376.00289690935;
                                     -21039.070620903 -48444.250382140235;
                                     -6195.618377983015 -16778.045594449453;
                                     -15686.073415243622 -46991.276375382586;
                                     -1716.0787284468345 -5836.722477919495;
                                     -2086.203482054124 -7695.75316205041;
                                     3418.087237993986 13994.826896081435;
                                     6065.271775021221 26578.18246467872;
                                     8424.676595366931 38797.069483575455] rtol = 1e-06
end

@testset "GLM:  NegativeBinomial with LogLink link - AnalyticWeights - method: dmethod" for (dmethod,
                                                                                             drop) in
                                                                                            itr

    model = glm(@formula(Days ~ Eth + Sex + Age + Lrn), quine, NegativeBinomial(2),
                LogLink(), wts=aweights(quine.aweights), method=dmethod,
                dropcollinear=drop, atol=1e-08, rtol=1e-08)
    @test deviance(model) ≈ 624.7631999565588 rtol = 1e-07
    @test loglikelihood(model) ≈ -2004.5939464322778 rtol = 1e-07
    @test coef(model) ≈ [3.02411915515531, -0.4641576651688563, 0.0718560942992554,
                         -0.47848540911607984, 0.09677889908013552, 0.3562972562034356,
                         0.3480161821981514] rtol = 1e-07
    @test stderror(model) ≈ [0.1950707397084349, 0.13200639191036218, 0.1373161597645507,
                             0.2088476016141468, 0.20252412726336674, 0.21060778935484836,
                             0.16126722793064027] rtol = 1e-07
    ## Tests below are broken because dof(model)==8 instead of 7
    @test_broken aic(model) ≈ 4023.1878928645556 rtol = 1e-07
    @test_broken bic(model) ≈ 4044.073139216514 rtol = 1e-07
    @test GLM.momentmatrix(model) ≈
          [-3.866780529709063 -0.0 -3.866780529709063 -0.0 -0.0 -0.0 -3.866780529709063
           -4.370085797122667 -0.0 -4.370085797122667 -0.0 -0.0 -0.0 -4.370085797122667
           -3.956562495375882 -0.0 -3.956562495375882 -0.0 -0.0 -0.0 -3.956562495375882
           -4.102299119258251 -0.0 -4.102299119258251 -0.0 -0.0 -0.0 -0.0
           -4.102299119258251 -0.0 -4.102299119258251 -0.0 -0.0 -0.0 -0.0
           -2.8243330916399567 -0.0 -2.8243330916399567 -0.0 -0.0 -0.0 -0.0
           -0.7247974261272416 -0.0 -0.7247974261272416 -0.0 -0.0 -0.0 -0.0
           -0.0382123316932152 -0.0 -0.0382123316932152 -0.0 -0.0 -0.0 -0.0
           -3.813241073891047 -0.0 -3.813241073891047 -3.813241073891047 -0.0 -0.0 -3.813241073891047
           -3.813241073891047 -0.0 -3.813241073891047 -3.813241073891047 -0.0 -0.0 -3.813241073891047
           -1.593192001014045 -0.0 -1.593192001014045 -1.593192001014045 -0.0 -0.0 -1.593192001014045
           -2.7127578570401822 -0.0 -2.7127578570401822 -2.7127578570401822 -0.0 -0.0 -0.0
           0.14484002662039835 0.0 0.14484002662039835 0.14484002662039835 0.0 0.0 0.0
           -4.754224412754331 -0.0 -4.754224412754331 -0.0 -4.754224412754331 -0.0 -4.754224412754331
           -0.6279394841753847 -0.0 -0.6279394841753847 -0.0 -0.6279394841753847 -0.0 -0.6279394841753847
           5.160032033317412 0.0 5.160032033317412 0.0 5.160032033317412 0.0 5.160032033317412
           6.363463014626628 0.0 6.363463014626628 0.0 6.363463014626628 0.0 6.363463014626628
           -2.991376095035898 -0.0 -2.991376095035898 -0.0 -2.991376095035898 -0.0 -0.0
           -2.492994950052581 -0.0 -2.492994950052581 -0.0 -2.492994950052581 -0.0 -0.0
           -2.492994950052581 -0.0 -2.492994950052581 -0.0 -2.492994950052581 -0.0 -0.0
           -2.226530220466526 -0.0 -2.226530220466526 -0.0 -2.226530220466526 -0.0 -0.0
           5.713017320814697 0.0 5.713017320814697 0.0 5.713017320814697 0.0 0.0
           6.908456992944485 0.0 6.908456992944485 0.0 6.908456992944485 0.0 0.0
           8.12839634400043 0.0 8.12839634400043 0.0 8.12839634400043 0.0 0.0
           -4.628254089687799 -0.0 -4.628254089687799 -0.0 -0.0 -4.628254089687799 -0.0
           -2.183958840253964 -0.0 -2.183958840253964 -0.0 -0.0 -2.183958840253964 -0.0
           -2.183958840253964 -0.0 -2.183958840253964 -0.0 -0.0 -2.183958840253964 -0.0
           -0.9503472567532946 -0.0 -0.9503472567532946 -0.0 -0.0 -0.9503472567532946 -0.0
           0.6731546773300909 0.0 0.6731546773300909 0.0 0.0 0.6731546773300909 0.0
           1.2423198758199778 0.0 1.2423198758199778 0.0 0.0 1.2423198758199778 0.0
           1.8236065476231822 0.0 1.8236065476231822 0.0 0.0 1.8236065476231822 0.0
           -4.171836641319677 -0.0 -0.0 -0.0 -0.0 -0.0 -4.171836641319677
           -3.9882995353410657 -0.0 -0.0 -0.0 -0.0 -0.0 -0.0
           -3.0399730926465205 -0.0 -0.0 -0.0 -0.0 -0.0 -0.0
           1.309672612863431 0.0 0.0 0.0 0.0 0.0 0.0
           10.661189363296968 0.0 0.0 0.0 0.0 0.0 0.0
           -3.7634043246260425 -0.0 -0.0 -3.7634043246260425 -0.0 -0.0 -3.7634043246260425
           -3.6605640772207546 -0.0 -0.0 -3.6605640772207546 -0.0 -0.0 -3.6605640772207546
           -3.6605640772207546 -0.0 -0.0 -3.6605640772207546 -0.0 -0.0 -3.6605640772207546
           -3.0720683496525485 -0.0 -0.0 -3.0720683496525485 -0.0 -0.0 -3.0720683496525485
           -1.885334027349047 -0.0 -0.0 -1.885334027349047 -0.0 -0.0 -1.885334027349047
           2.106807550276347 0.0 0.0 2.106807550276347 0.0 0.0 2.106807550276347
           3.0150038937286183 0.0 0.0 3.0150038937286183 0.0 0.0 3.0150038937286183
           6.387064937752826 0.0 0.0 6.387064937752826 0.0 0.0 6.387064937752826
           17.72394862307137 0.0 0.0 17.72394862307137 0.0 0.0 17.72394862307137
           18.296957173355864 0.0 0.0 18.296957173355864 0.0 0.0 18.296957173355864
           -3.0375213985118954 -0.0 -0.0 -3.0375213985118954 -0.0 -0.0 -0.0
           -3.0375213985118954 -0.0 -0.0 -3.0375213985118954 -0.0 -0.0 -0.0
           -0.8508688349707806 -0.0 -0.0 -0.8508688349707806 -0.0 -0.0 -0.0
           2.2977798382338515 0.0 0.0 2.2977798382338515 0.0 0.0 0.0
           3.4686807301080997 0.0 0.0 3.4686807301080997 0.0 0.0 0.0
           -4.658715933989554 -0.0 -0.0 -0.0 -4.658715933989554 -0.0 -4.658715933989554
           -4.187227633826471 -0.0 -0.0 -0.0 -4.187227633826471 -0.0 -4.187227633826471
           -4.04126740785402 -0.0 -0.0 -0.0 -4.04126740785402 -0.0 -4.04126740785402
           -2.940568463040927 -0.0 -0.0 -0.0 -2.940568463040927 -0.0 -2.940568463040927
           4.342318636532548 0.0 0.0 0.0 4.342318636532548 0.0 4.342318636532548
           4.653011109293142 0.0 0.0 0.0 4.653011109293142 0.0 4.653011109293142
           8.523536317826032 0.0 0.0 0.0 8.523536317826032 0.0 8.523536317826032
           15.787943104351504 0.0 0.0 0.0 15.787943104351504 0.0 15.787943104351504
           -3.6818016272511183 -0.0 -0.0 -0.0 -3.6818016272511183 -0.0 -0.0
           -2.057196136670586 -0.0 -0.0 -0.0 -0.0 -2.057196136670586 -0.0
           -3.834339745304657 -0.0 -0.0 -0.0 -0.0 -3.834339745304657 -0.0
           -4.1780090350069425 -0.0 -0.0 -0.0 -0.0 -4.1780090350069425 -0.0
           -4.491340364181187 -0.0 -0.0 -0.0 -0.0 -4.491340364181187 -0.0
           -4.3190736545666875 -0.0 -0.0 -0.0 -0.0 -4.3190736545666875 -0.0
           -3.731819061288569 -0.0 -0.0 -0.0 -0.0 -3.731819061288569 -0.0
           -2.238272513055515 -0.0 -0.0 -0.0 -0.0 -2.238272513055515 -0.0
           1.9859737921268132 0.0 0.0 0.0 0.0 1.9859737921268132 0.0
           3.2559592797891495 0.0 0.0 0.0 0.0 3.2559592797891495 0.0
           -3.8426774654770597 -3.8426774654770597 -3.8426774654770597 -0.0 -0.0 -0.0 -3.8426774654770597
           -0.9876822943882244 -0.9876822943882244 -0.9876822943882244 -0.0 -0.0 -0.0 -0.9876822943882244
           23.20842027925341 23.20842027925341 23.20842027925341 0.0 0.0 0.0 23.20842027925341
           -1.920845416870046 -1.920845416870046 -1.920845416870046 -0.0 -0.0 -0.0 -0.0
           -1.920845416870046 -1.920845416870046 -1.920845416870046 -0.0 -0.0 -0.0 -0.0
           -3.2888901738202923 -3.2888901738202923 -3.2888901738202923 -0.0 -0.0 -0.0 -0.0
           -2.758113321833414 -2.758113321833414 -2.758113321833414 -0.0 -0.0 -0.0 -0.0
           -1.306843142455193 -1.306843142455193 -1.306843142455193 -0.0 -0.0 -0.0 -0.0
           -0.8751747276035264 -0.8751747276035264 -0.8751747276035264 -0.0 -0.0 -0.0 -0.0
           -1.8877508012966644 -1.8877508012966644 -1.8877508012966644 -1.8877508012966644 -0.0 -0.0 -1.8877508012966644
           -1.8877508012966644 -1.8877508012966644 -1.8877508012966644 -1.8877508012966644 -0.0 -0.0 -1.8877508012966644
           -2.9308943363443847 -2.9308943363443847 -2.9308943363443847 -2.9308943363443847 -0.0 -0.0 -2.9308943363443847
           -2.9308943363443847 -2.9308943363443847 -2.9308943363443847 -2.9308943363443847 -0.0 -0.0 -2.9308943363443847
           -2.9308943363443847 -2.9308943363443847 -2.9308943363443847 -2.9308943363443847 -0.0 -0.0 -2.9308943363443847
           -0.6051770620747217 -0.6051770620747217 -0.6051770620747217 -0.6051770620747217 -0.0 -0.0 -0.6051770620747217
           2.697606708942873 2.697606708942873 2.697606708942873 2.697606708942873 0.0 0.0 2.697606708942873
           -2.628558928820721 -2.628558928820721 -2.628558928820721 -2.628558928820721 -0.0 -0.0 -0.0
           -2.3542975772061085 -2.3542975772061085 -2.3542975772061085 -2.3542975772061085 -0.0 -0.0 -0.0
           0.11268811798135936 0.11268811798135936 0.11268811798135936 0.0 0.11268811798135936 0.0 0.11268811798135936
           3.1826005245112854 3.1826005245112854 3.1826005245112854 0.0 3.1826005245112854 0.0 3.1826005245112854
           5.692953263520725 5.692953263520725 5.692953263520725 0.0 5.692953263520725 0.0 5.692953263520725
           -2.7839804243079254 -2.7839804243079254 -2.7839804243079254 -0.0 -2.7839804243079254 -0.0 -0.0
           -1.9433894208611948 -1.9433894208611948 -1.9433894208611948 -0.0 -1.9433894208611948 -0.0 -0.0
           -2.962526696741388 -2.962526696741388 -2.962526696741388 -0.0 -2.962526696741388 -0.0 -0.0
           -3.4432739212266052 -3.4432739212266052 -3.4432739212266052 -0.0 -3.4432739212266052 -0.0 -0.0
           -3.0516553688541084 -3.0516553688541084 -3.0516553688541084 -0.0 -3.0516553688541084 -0.0 -0.0
           0.3128048727055356 0.3128048727055356 0.3128048727055356 0.0 0.3128048727055356 0.0 0.0
           5.983398649554576 5.983398649554576 5.983398649554576 0.0 5.983398649554576 0.0 0.0
           -1.9961184031161041 -1.9961184031161041 -1.9961184031161041 -0.0 -0.0 -1.9961184031161041 -0.0
           4.212201806010905 4.212201806010905 4.212201806010905 0.0 0.0 4.212201806010905 0.0
           -3.152192412974143 -3.152192412974143 -3.152192412974143 -0.0 -0.0 -3.152192412974143 -0.0
           -2.03792823060008 -2.03792823060008 -2.03792823060008 -0.0 -0.0 -2.03792823060008 -0.0
           2.9007973162738843 2.9007973162738843 2.9007973162738843 0.0 0.0 2.9007973162738843 0.0
           9.364366020386104 9.364366020386104 9.364366020386104 0.0 0.0 9.364366020386104 0.0
           24.059031354439128 24.059031354439128 24.059031354439128 0.0 0.0 24.059031354439128 0.0
           2.864621620127876 2.864621620127876 0.0 0.0 0.0 0.0 2.864621620127876
           -1.374372490365048 -1.374372490365048 -0.0 -0.0 -0.0 -0.0 -0.0
           -0.9287032240778311 -0.9287032240778311 -0.0 -0.0 -0.0 -0.0 -0.0
           3.919550403175515 3.919550403175515 0.0 0.0 0.0 0.0 0.0
           12.426707944681816 12.426707944681816 0.0 0.0 0.0 0.0 0.0
           -2.750339462985501 -2.750339462985501 -0.0 -2.750339462985501 -0.0 -0.0 -2.750339462985501
           -2.0720837572297617 -2.0720837572297617 -0.0 -2.0720837572297617 -0.0 -0.0 -2.0720837572297617
           -1.8681224147832116 -1.8681224147832116 -0.0 -1.8681224147832116 -0.0 -0.0 -1.8681224147832116
           -2.778411659017331 -2.778411659017331 -0.0 -2.778411659017331 -0.0 -0.0 -2.778411659017331
           -2.750339462985501 -2.750339462985501 -0.0 -2.750339462985501 -0.0 -0.0 -2.750339462985501
           -2.750339462985501 -2.750339462985501 -0.0 -2.750339462985501 -0.0 -0.0 -2.750339462985501
           -2.750339462985501 -2.750339462985501 -0.0 -2.750339462985501 -0.0 -0.0 -2.750339462985501
           -2.750339462985501 -2.750339462985501 -0.0 -2.750339462985501 -0.0 -0.0 -2.750339462985501
           -2.0720837572297617 -2.0720837572297617 -0.0 -2.0720837572297617 -0.0 -0.0 -2.0720837572297617
           -0.18952790670731487 -0.18952790670731487 -0.0 -0.18952790670731487 -0.0 -0.0 -0.18952790670731487
           2.1145280030507307 2.1145280030507307 0.0 2.1145280030507307 0.0 0.0 2.1145280030507307
           -1.7407825357737137 -1.7407825357737137 -0.0 -1.7407825357737137 -0.0 -0.0 -0.0
           4.548120970699322 4.548120970699322 0.0 4.548120970699322 0.0 0.0 0.0
           -1.2257166987183963 -1.2257166987183963 -0.0 -1.2257166987183963 -0.0 -0.0 -0.0
           -1.2257166987183963 -1.2257166987183963 -0.0 -1.2257166987183963 -0.0 -0.0 -0.0
           -0.6449075179371568 -0.6449075179371568 -0.0 -0.6449075179371568 -0.0 -0.0 -0.0
           17.819813171012125 17.819813171012125 0.0 17.819813171012125 0.0 0.0 0.0
           -1.999110422648601 -1.999110422648601 -0.0 -0.0 -1.999110422648601 -0.0 -1.999110422648601
           -3.9564518053768536 -3.9564518053768536 -0.0 -0.0 -3.9564518053768536 -0.0 -3.9564518053768536
           -2.1216196203872557 -2.1216196203872557 -0.0 -0.0 -2.1216196203872557 -0.0 -2.1216196203872557
           -3.601990642806918 -3.601990642806918 -0.0 -0.0 -3.601990642806918 -0.0 -3.601990642806918
           -3.601990642806918 -3.601990642806918 -0.0 -0.0 -3.601990642806918 -0.0 -3.601990642806918
           -3.8495441274063715 -3.8495441274063715 -0.0 -0.0 -3.8495441274063715 -0.0 -3.8495441274063715
           -3.6199500530041027 -3.6199500530041027 -0.0 -0.0 -3.6199500530041027 -0.0 -3.6199500530041027
           -3.209822061567088 -3.209822061567088 -0.0 -0.0 -3.209822061567088 -0.0 -3.209822061567088
           -2.702521155801149 -2.702521155801149 -0.0 -0.0 -2.702521155801149 -0.0 -2.702521155801149
           -2.921923505820458 -2.921923505820458 -0.0 -0.0 -2.921923505820458 -0.0 -0.0
           -3.058405902935942 -3.058405902935942 -0.0 -0.0 -0.0 -3.058405902935942 -0.0
           -3.1473667781351766 -3.1473667781351766 -0.0 -0.0 -0.0 -3.1473667781351766 -0.0
           1.4593378269316923 1.4593378269316923 0.0 0.0 0.0 1.4593378269316923 0.0
           -3.7560337640183694 -3.7560337640183694 -0.0 -0.0 -0.0 -3.7560337640183694 -0.0
           -3.7560337640183694 -3.7560337640183694 -0.0 -0.0 -0.0 -3.7560337640183694 -0.0
           -3.8041614268127484 -3.8041614268127484 -0.0 -0.0 -0.0 -3.8041614268127484 -0.0
           -1.3131162740760067 -1.3131162740760067 -0.0 -0.0 -0.0 -1.3131162740760067 -0.0
           -0.18645252170591944 -0.18645252170591944 -0.0 -0.0 -0.0 -0.18645252170591944 -0.0
           1.4593378269316923 1.4593378269316923 0.0 0.0 0.0 1.4593378269316923 0.0
           8.572921389223637 8.572921389223637 0.0 0.0 0.0 8.572921389223637 0.0] rtol = 1e-04
end

@testset "GLM:  NegativeBinomial with LogLink link - AnalyticWeights with $dmethod method" for (dmethod,
                                                                                                drop) in
                                                                                               itr

    model = glm(@formula(Days ~ Eth + Sex + Age + Lrn), quine,
                NegativeBinomial(2), LogLink(), wts=aweights(quine.aweights),
                method=dmethod, dropcollinear=drop, rtol=1e-08, atol=1e-08)
    @test deviance(model) ≈ 624.7631999565588 rtol = 1e-07
    @test loglikelihood(model) ≈ -2004.5939464322778 rtol = 1e-07
    @test coef(model) ≈ [3.02411915515531, -0.4641576651688563, 0.0718560942992554,
                         -0.47848540911607984, 0.09677889908013552, 0.3562972562034356,
                         0.3480161821981514] rtol = 1e-07
    @test stderror(model) ≈ [0.1950707397084349, 0.13200639191036218, 0.1373161597645507,
                             0.2088476016141468, 0.20252412726336674, 0.21060778935484836,
                             0.16126722793064027] rtol = 1e-07
    @test_broken GLM.aic(model) ≈ 4023.1878928645556 rtol = 1e-07
    @test_broken GLM.bic(model) ≈ 4044.073139216514 rtol = 1e-07
    @test GLM.momentmatrix(model) ≈
          [-3.866780529709063 -0.0 -3.866780529709063 -0.0 -0.0 -0.0 -3.866780529709063
           -4.370085797122667 -0.0 -4.370085797122667 -0.0 -0.0 -0.0 -4.370085797122667
           -3.956562495375882 -0.0 -3.956562495375882 -0.0 -0.0 -0.0 -3.956562495375882
           -4.102299119258251 -0.0 -4.102299119258251 -0.0 -0.0 -0.0 -0.0
           -4.102299119258251 -0.0 -4.102299119258251 -0.0 -0.0 -0.0 -0.0
           -2.8243330916399567 -0.0 -2.8243330916399567 -0.0 -0.0 -0.0 -0.0
           -0.7247974261272416 -0.0 -0.7247974261272416 -0.0 -0.0 -0.0 -0.0
           -0.0382123316932152 -0.0 -0.0382123316932152 -0.0 -0.0 -0.0 -0.0
           -3.813241073891047 -0.0 -3.813241073891047 -3.813241073891047 -0.0 -0.0 -3.813241073891047
           -3.813241073891047 -0.0 -3.813241073891047 -3.813241073891047 -0.0 -0.0 -3.813241073891047
           -1.593192001014045 -0.0 -1.593192001014045 -1.593192001014045 -0.0 -0.0 -1.593192001014045
           -2.7127578570401822 -0.0 -2.7127578570401822 -2.7127578570401822 -0.0 -0.0 -0.0
           0.14484002662039835 0.0 0.14484002662039835 0.14484002662039835 0.0 0.0 0.0
           -4.754224412754331 -0.0 -4.754224412754331 -0.0 -4.754224412754331 -0.0 -4.754224412754331
           -0.6279394841753847 -0.0 -0.6279394841753847 -0.0 -0.6279394841753847 -0.0 -0.6279394841753847
           5.160032033317412 0.0 5.160032033317412 0.0 5.160032033317412 0.0 5.160032033317412
           6.363463014626628 0.0 6.363463014626628 0.0 6.363463014626628 0.0 6.363463014626628
           -2.991376095035898 -0.0 -2.991376095035898 -0.0 -2.991376095035898 -0.0 -0.0
           -2.492994950052581 -0.0 -2.492994950052581 -0.0 -2.492994950052581 -0.0 -0.0
           -2.492994950052581 -0.0 -2.492994950052581 -0.0 -2.492994950052581 -0.0 -0.0
           -2.226530220466526 -0.0 -2.226530220466526 -0.0 -2.226530220466526 -0.0 -0.0
           5.713017320814697 0.0 5.713017320814697 0.0 5.713017320814697 0.0 0.0
           6.908456992944485 0.0 6.908456992944485 0.0 6.908456992944485 0.0 0.0
           8.12839634400043 0.0 8.12839634400043 0.0 8.12839634400043 0.0 0.0
           -4.628254089687799 -0.0 -4.628254089687799 -0.0 -0.0 -4.628254089687799 -0.0
           -2.183958840253964 -0.0 -2.183958840253964 -0.0 -0.0 -2.183958840253964 -0.0
           -2.183958840253964 -0.0 -2.183958840253964 -0.0 -0.0 -2.183958840253964 -0.0
           -0.9503472567532946 -0.0 -0.9503472567532946 -0.0 -0.0 -0.9503472567532946 -0.0
           0.6731546773300909 0.0 0.6731546773300909 0.0 0.0 0.6731546773300909 0.0
           1.2423198758199778 0.0 1.2423198758199778 0.0 0.0 1.2423198758199778 0.0
           1.8236065476231822 0.0 1.8236065476231822 0.0 0.0 1.8236065476231822 0.0
           -4.171836641319677 -0.0 -0.0 -0.0 -0.0 -0.0 -4.171836641319677
           -3.9882995353410657 -0.0 -0.0 -0.0 -0.0 -0.0 -0.0
           -3.0399730926465205 -0.0 -0.0 -0.0 -0.0 -0.0 -0.0
           1.309672612863431 0.0 0.0 0.0 0.0 0.0 0.0
           10.661189363296968 0.0 0.0 0.0 0.0 0.0 0.0
           -3.7634043246260425 -0.0 -0.0 -3.7634043246260425 -0.0 -0.0 -3.7634043246260425
           -3.6605640772207546 -0.0 -0.0 -3.6605640772207546 -0.0 -0.0 -3.6605640772207546
           -3.6605640772207546 -0.0 -0.0 -3.6605640772207546 -0.0 -0.0 -3.6605640772207546
           -3.0720683496525485 -0.0 -0.0 -3.0720683496525485 -0.0 -0.0 -3.0720683496525485
           -1.885334027349047 -0.0 -0.0 -1.885334027349047 -0.0 -0.0 -1.885334027349047
           2.106807550276347 0.0 0.0 2.106807550276347 0.0 0.0 2.106807550276347
           3.0150038937286183 0.0 0.0 3.0150038937286183 0.0 0.0 3.0150038937286183
           6.387064937752826 0.0 0.0 6.387064937752826 0.0 0.0 6.387064937752826
           17.72394862307137 0.0 0.0 17.72394862307137 0.0 0.0 17.72394862307137
           18.296957173355864 0.0 0.0 18.296957173355864 0.0 0.0 18.296957173355864
           -3.0375213985118954 -0.0 -0.0 -3.0375213985118954 -0.0 -0.0 -0.0
           -3.0375213985118954 -0.0 -0.0 -3.0375213985118954 -0.0 -0.0 -0.0
           -0.8508688349707806 -0.0 -0.0 -0.8508688349707806 -0.0 -0.0 -0.0
           2.2977798382338515 0.0 0.0 2.2977798382338515 0.0 0.0 0.0
           3.4686807301080997 0.0 0.0 3.4686807301080997 0.0 0.0 0.0
           -4.658715933989554 -0.0 -0.0 -0.0 -4.658715933989554 -0.0 -4.658715933989554
           -4.187227633826471 -0.0 -0.0 -0.0 -4.187227633826471 -0.0 -4.187227633826471
           -4.04126740785402 -0.0 -0.0 -0.0 -4.04126740785402 -0.0 -4.04126740785402
           -2.940568463040927 -0.0 -0.0 -0.0 -2.940568463040927 -0.0 -2.940568463040927
           4.342318636532548 0.0 0.0 0.0 4.342318636532548 0.0 4.342318636532548
           4.653011109293142 0.0 0.0 0.0 4.653011109293142 0.0 4.653011109293142
           8.523536317826032 0.0 0.0 0.0 8.523536317826032 0.0 8.523536317826032
           15.787943104351504 0.0 0.0 0.0 15.787943104351504 0.0 15.787943104351504
           -3.6818016272511183 -0.0 -0.0 -0.0 -3.6818016272511183 -0.0 -0.0
           -2.057196136670586 -0.0 -0.0 -0.0 -0.0 -2.057196136670586 -0.0
           -3.834339745304657 -0.0 -0.0 -0.0 -0.0 -3.834339745304657 -0.0
           -4.1780090350069425 -0.0 -0.0 -0.0 -0.0 -4.1780090350069425 -0.0
           -4.491340364181187 -0.0 -0.0 -0.0 -0.0 -4.491340364181187 -0.0
           -4.3190736545666875 -0.0 -0.0 -0.0 -0.0 -4.3190736545666875 -0.0
           -3.731819061288569 -0.0 -0.0 -0.0 -0.0 -3.731819061288569 -0.0
           -2.238272513055515 -0.0 -0.0 -0.0 -0.0 -2.238272513055515 -0.0
           1.9859737921268132 0.0 0.0 0.0 0.0 1.9859737921268132 0.0
           3.2559592797891495 0.0 0.0 0.0 0.0 3.2559592797891495 0.0
           -3.8426774654770597 -3.8426774654770597 -3.8426774654770597 -0.0 -0.0 -0.0 -3.8426774654770597
           -0.9876822943882244 -0.9876822943882244 -0.9876822943882244 -0.0 -0.0 -0.0 -0.9876822943882244
           23.20842027925341 23.20842027925341 23.20842027925341 0.0 0.0 0.0 23.20842027925341
           -1.920845416870046 -1.920845416870046 -1.920845416870046 -0.0 -0.0 -0.0 -0.0
           -1.920845416870046 -1.920845416870046 -1.920845416870046 -0.0 -0.0 -0.0 -0.0
           -3.2888901738202923 -3.2888901738202923 -3.2888901738202923 -0.0 -0.0 -0.0 -0.0
           -2.758113321833414 -2.758113321833414 -2.758113321833414 -0.0 -0.0 -0.0 -0.0
           -1.306843142455193 -1.306843142455193 -1.306843142455193 -0.0 -0.0 -0.0 -0.0
           -0.8751747276035264 -0.8751747276035264 -0.8751747276035264 -0.0 -0.0 -0.0 -0.0
           -1.8877508012966644 -1.8877508012966644 -1.8877508012966644 -1.8877508012966644 -0.0 -0.0 -1.8877508012966644
           -1.8877508012966644 -1.8877508012966644 -1.8877508012966644 -1.8877508012966644 -0.0 -0.0 -1.8877508012966644
           -2.9308943363443847 -2.9308943363443847 -2.9308943363443847 -2.9308943363443847 -0.0 -0.0 -2.9308943363443847
           -2.9308943363443847 -2.9308943363443847 -2.9308943363443847 -2.9308943363443847 -0.0 -0.0 -2.9308943363443847
           -2.9308943363443847 -2.9308943363443847 -2.9308943363443847 -2.9308943363443847 -0.0 -0.0 -2.9308943363443847
           -0.6051770620747217 -0.6051770620747217 -0.6051770620747217 -0.6051770620747217 -0.0 -0.0 -0.6051770620747217
           2.697606708942873 2.697606708942873 2.697606708942873 2.697606708942873 0.0 0.0 2.697606708942873
           -2.628558928820721 -2.628558928820721 -2.628558928820721 -2.628558928820721 -0.0 -0.0 -0.0
           -2.3542975772061085 -2.3542975772061085 -2.3542975772061085 -2.3542975772061085 -0.0 -0.0 -0.0
           0.11268811798135936 0.11268811798135936 0.11268811798135936 0.0 0.11268811798135936 0.0 0.11268811798135936
           3.1826005245112854 3.1826005245112854 3.1826005245112854 0.0 3.1826005245112854 0.0 3.1826005245112854
           5.692953263520725 5.692953263520725 5.692953263520725 0.0 5.692953263520725 0.0 5.692953263520725
           -2.7839804243079254 -2.7839804243079254 -2.7839804243079254 -0.0 -2.7839804243079254 -0.0 -0.0
           -1.9433894208611948 -1.9433894208611948 -1.9433894208611948 -0.0 -1.9433894208611948 -0.0 -0.0
           -2.962526696741388 -2.962526696741388 -2.962526696741388 -0.0 -2.962526696741388 -0.0 -0.0
           -3.4432739212266052 -3.4432739212266052 -3.4432739212266052 -0.0 -3.4432739212266052 -0.0 -0.0
           -3.0516553688541084 -3.0516553688541084 -3.0516553688541084 -0.0 -3.0516553688541084 -0.0 -0.0
           0.3128048727055356 0.3128048727055356 0.3128048727055356 0.0 0.3128048727055356 0.0 0.0
           5.983398649554576 5.983398649554576 5.983398649554576 0.0 5.983398649554576 0.0 0.0
           -1.9961184031161041 -1.9961184031161041 -1.9961184031161041 -0.0 -0.0 -1.9961184031161041 -0.0
           4.212201806010905 4.212201806010905 4.212201806010905 0.0 0.0 4.212201806010905 0.0
           -3.152192412974143 -3.152192412974143 -3.152192412974143 -0.0 -0.0 -3.152192412974143 -0.0
           -2.03792823060008 -2.03792823060008 -2.03792823060008 -0.0 -0.0 -2.03792823060008 -0.0
           2.9007973162738843 2.9007973162738843 2.9007973162738843 0.0 0.0 2.9007973162738843 0.0
           9.364366020386104 9.364366020386104 9.364366020386104 0.0 0.0 9.364366020386104 0.0
           24.059031354439128 24.059031354439128 24.059031354439128 0.0 0.0 24.059031354439128 0.0
           2.864621620127876 2.864621620127876 0.0 0.0 0.0 0.0 2.864621620127876
           -1.374372490365048 -1.374372490365048 -0.0 -0.0 -0.0 -0.0 -0.0
           -0.9287032240778311 -0.9287032240778311 -0.0 -0.0 -0.0 -0.0 -0.0
           3.919550403175515 3.919550403175515 0.0 0.0 0.0 0.0 0.0
           12.426707944681816 12.426707944681816 0.0 0.0 0.0 0.0 0.0
           -2.750339462985501 -2.750339462985501 -0.0 -2.750339462985501 -0.0 -0.0 -2.750339462985501
           -2.0720837572297617 -2.0720837572297617 -0.0 -2.0720837572297617 -0.0 -0.0 -2.0720837572297617
           -1.8681224147832116 -1.8681224147832116 -0.0 -1.8681224147832116 -0.0 -0.0 -1.8681224147832116
           -2.778411659017331 -2.778411659017331 -0.0 -2.778411659017331 -0.0 -0.0 -2.778411659017331
           -2.750339462985501 -2.750339462985501 -0.0 -2.750339462985501 -0.0 -0.0 -2.750339462985501
           -2.750339462985501 -2.750339462985501 -0.0 -2.750339462985501 -0.0 -0.0 -2.750339462985501
           -2.750339462985501 -2.750339462985501 -0.0 -2.750339462985501 -0.0 -0.0 -2.750339462985501
           -2.750339462985501 -2.750339462985501 -0.0 -2.750339462985501 -0.0 -0.0 -2.750339462985501
           -2.0720837572297617 -2.0720837572297617 -0.0 -2.0720837572297617 -0.0 -0.0 -2.0720837572297617
           -0.18952790670731487 -0.18952790670731487 -0.0 -0.18952790670731487 -0.0 -0.0 -0.18952790670731487
           2.1145280030507307 2.1145280030507307 0.0 2.1145280030507307 0.0 0.0 2.1145280030507307
           -1.7407825357737137 -1.7407825357737137 -0.0 -1.7407825357737137 -0.0 -0.0 -0.0
           4.548120970699322 4.548120970699322 0.0 4.548120970699322 0.0 0.0 0.0
           -1.2257166987183963 -1.2257166987183963 -0.0 -1.2257166987183963 -0.0 -0.0 -0.0
           -1.2257166987183963 -1.2257166987183963 -0.0 -1.2257166987183963 -0.0 -0.0 -0.0
           -0.6449075179371568 -0.6449075179371568 -0.0 -0.6449075179371568 -0.0 -0.0 -0.0
           17.819813171012125 17.819813171012125 0.0 17.819813171012125 0.0 0.0 0.0
           -1.999110422648601 -1.999110422648601 -0.0 -0.0 -1.999110422648601 -0.0 -1.999110422648601
           -3.9564518053768536 -3.9564518053768536 -0.0 -0.0 -3.9564518053768536 -0.0 -3.9564518053768536
           -2.1216196203872557 -2.1216196203872557 -0.0 -0.0 -2.1216196203872557 -0.0 -2.1216196203872557
           -3.601990642806918 -3.601990642806918 -0.0 -0.0 -3.601990642806918 -0.0 -3.601990642806918
           -3.601990642806918 -3.601990642806918 -0.0 -0.0 -3.601990642806918 -0.0 -3.601990642806918
           -3.8495441274063715 -3.8495441274063715 -0.0 -0.0 -3.8495441274063715 -0.0 -3.8495441274063715
           -3.6199500530041027 -3.6199500530041027 -0.0 -0.0 -3.6199500530041027 -0.0 -3.6199500530041027
           -3.209822061567088 -3.209822061567088 -0.0 -0.0 -3.209822061567088 -0.0 -3.209822061567088
           -2.702521155801149 -2.702521155801149 -0.0 -0.0 -2.702521155801149 -0.0 -2.702521155801149
           -2.921923505820458 -2.921923505820458 -0.0 -0.0 -2.921923505820458 -0.0 -0.0
           -3.058405902935942 -3.058405902935942 -0.0 -0.0 -0.0 -3.058405902935942 -0.0
           -3.1473667781351766 -3.1473667781351766 -0.0 -0.0 -0.0 -3.1473667781351766 -0.0
           1.4593378269316923 1.4593378269316923 0.0 0.0 0.0 1.4593378269316923 0.0
           -3.7560337640183694 -3.7560337640183694 -0.0 -0.0 -0.0 -3.7560337640183694 -0.0
           -3.7560337640183694 -3.7560337640183694 -0.0 -0.0 -0.0 -3.7560337640183694 -0.0
           -3.8041614268127484 -3.8041614268127484 -0.0 -0.0 -0.0 -3.8041614268127484 -0.0
           -1.3131162740760067 -1.3131162740760067 -0.0 -0.0 -0.0 -1.3131162740760067 -0.0
           -0.18645252170591944 -0.18645252170591944 -0.0 -0.0 -0.0 -0.18645252170591944 -0.0
           1.4593378269316923 1.4593378269316923 0.0 0.0 0.0 1.4593378269316923 0.0
           8.572921389223637 8.572921389223637 0.0 0.0 0.0 8.572921389223637 0.0] rtol = 1e-04
end

@testset "GLM:  NegativeBinomial with SqrtLink link - AnalyticWeights with $dmethod method" for (dmethod,
                                                                                                 drop) in
                                                                                                itr

    model = glm(@formula(Days ~ Eth + Sex + Age + Lrn), quine, NegativeBinomial(2),
                SqrtLink(), wts=aweights(quine.aweights),
                method=dmethod, dropcollinear=drop, rtol=1e-08, atol=1e-09)
    @test deviance(model) ≈ 626.6464732988984 rtol = 1e-07
    @test loglikelihood(model) ≈ -2005.5355831034462 rtol = 1e-07
    @test coef(model) ≈ [4.733877229152363, -1.007977895471349, 0.02522392818548873,
                         -0.9859743168046422, 0.2132095063819721, 0.7456070470961186,
                         0.5840284357554036] rtol = 1e-07
    @test stderror(model) ≈ [0.42307979153860564, 0.286636744566765, 0.29612422536777805,
                             0.42042723748229144, 0.45565954626859695, 0.4766324296069839,
                             0.3235019638755972] rtol = 1e-06
    @test_broken GLM.aic(model) ≈ 4025.0711662068925 rtol = 1e-07
    @test_broken GLM.bic(model) ≈ 4045.956412558851 rtol = 1e-07
    @test GLM.momentmatrix(model) ≈
          [-1.4294351675636041 -0.0 -1.4294351675636041 -0.0 -0.0 -0.0 -1.4294351675636041
           -1.5410055711037194 -0.0 -1.5410055711037194 -0.0 -0.0 -0.0 -1.5410055711037194
           -1.3571249039047424 -0.0 -1.3571249039047424 -0.0 -0.0 -0.0 -1.3571249039047424
           -1.7394058711709879 -0.0 -1.7394058711709879 -0.0 -0.0 -0.0 -0.0
           -1.7394058711709879 -0.0 -1.7394058711709879 -0.0 -0.0 -0.0 -0.0
           -1.229734152157926 -0.0 -1.229734152157926 -0.0 -0.0 -0.0 -0.0
           -0.3742348640443611 -0.0 -0.3742348640443611 -0.0 -0.0 -0.0 -0.0
           -0.09370480172054219 -0.0 -0.09370480172054219 -0.0 -0.0 -0.0 -0.0
           -1.7293809063089827 -0.0 -1.7293809063089827 -1.7293809063089827 -0.0 -0.0 -1.7293809063089827
           -1.7293809063089827 -0.0 -1.7293809063089827 -1.7293809063089827 -0.0 -0.0 -1.7293809063089827
           -0.6748210571645206 -0.0 -0.6748210571645206 -0.6748210571645206 -0.0 -0.0 -0.6748210571645206
           -1.5016227445218024 -0.0 -1.5016227445218024 -1.5016227445218024 -0.0 -0.0 -0.0
           -0.058778966482651636 -0.0 -0.058778966482651636 -0.058778966482651636 -0.0 -0.0 -0.0
           -1.6582836355486288 -0.0 -1.6582836355486288 -0.0 -1.6582836355486288 -0.0 -1.6582836355486288
           0.11341508381030255 0.0 0.11341508381030255 0.0 0.11341508381030255 0.0 0.11341508381030255
           2.4651888863431344 0.0 2.4651888863431344 0.0 2.4651888863431344 0.0 2.4651888863431344
           2.9517152556309942 0.0 2.9517152556309942 0.0 2.9517152556309942 0.0 2.9517152556309942
           -1.2288386266845785 -0.0 -1.2288386266845785 -0.0 -1.2288386266845785 -0.0 -0.0
           -1.0325293533841053 -0.0 -1.0325293533841053 -0.0 -1.0325293533841053 -0.0 -0.0
           -1.0325293533841053 -0.0 -1.0325293533841053 -0.0 -1.0325293533841053 -0.0 -0.0
           -0.9274622643228648 -0.0 -0.9274622643228648 -0.0 -0.9274622643228648 -0.0 -0.0
           2.212861910664014 0.0 2.212861910664014 0.0 2.212861910664014 0.0 0.0
           2.6862849076558937 0.0 2.6862849076558937 0.0 2.6862849076558937 0.0 0.0
           3.1694781034873523 0.0 3.1694781034873523 0.0 3.1694781034873523 0.0 0.0
           -1.6534192741665588 -0.0 -1.6534192741665588 -0.0 -0.0 -1.6534192741665588 -0.0
           -0.702446330017668 -0.0 -0.702446330017668 -0.0 -0.0 -0.702446330017668 -0.0
           -0.702446330017668 -0.0 -0.702446330017668 -0.0 -0.0 -0.702446330017668 -0.0
           -0.23123674216762394 -0.0 -0.23123674216762394 -0.0 -0.0 -0.23123674216762394 -0.0
           0.3871584524726257 0.0 0.3871584524726257 0.0 0.0 0.3871584524726257 0.0
           0.6036586921589513 0.0 0.6036586921589513 0.0 0.0 0.6036586921589513 0.0
           0.8246522973739006 0.0 0.8246522973739006 0.0 0.0 0.8246522973739006 0.0
           -1.560441651521342 -0.0 -0.0 -0.0 -0.0 -0.0 -1.560441651521342
           -1.7419685003857353 -0.0 -0.0 -0.0 -0.0 -0.0 -0.0
           -1.4153955925789807 -0.0 -0.0 -0.0 -0.0 -0.0 -0.0
           0.23770439864218734 0.0 0.0 0.0 0.0 0.0 0.0
           3.853247675936175 0.0 0.0 0.0 0.0 0.0 0.0
           -1.7692672149493731 -0.0 -0.0 -1.7692672149493731 -0.0 -0.0 -1.7692672149493731
           -1.7282440188407218 -0.0 -0.0 -1.7282440188407218 -0.0 -0.0 -1.7282440188407218
           -1.7282440188407218 -0.0 -0.0 -1.7282440188407218 -0.0 -0.0 -1.7282440188407218
           -1.4769837741682987 -0.0 -0.0 -1.4769837741682987 -0.0 -0.0 -1.4769837741682987
           -0.9582774689727417 -0.0 -0.0 -0.9582774689727417 -0.0 -0.0 -0.9582774689727417
           0.8052632685284861 0.0 0.0 0.8052632685284861 0.0 0.0 0.8052632685284861
           1.2077994352773953 0.0 0.0 1.2077994352773953 0.0 0.0 1.2077994352773953
           2.7042310768987665 0.0 0.0 2.7042310768987665 0.0 0.0 2.7042310768987665
           7.744950633464035 0.0 0.0 7.744950633464035 0.0 0.0 7.744950633464035
           7.999933021719232 0.0 0.0 7.999933021719232 0.0 0.0 7.999933021719232
           -1.7392669278461907 -0.0 -0.0 -1.7392669278461907 -0.0 -0.0 -0.0
           -1.7392669278461907 -0.0 -0.0 -1.7392669278461907 -0.0 -0.0 -0.0
           -0.7262212443523531 -0.0 -0.0 -0.7262212443523531 -0.0 -0.0 -0.0
           0.7835691668207807 0.0 0.0 0.7835691668207807 0.0 0.0 0.0
           1.3489349925379315 0.0 0.0 1.3489349925379315 0.0 0.0 0.0
           -1.6522100272913283 -0.0 -0.0 -0.0 -1.6522100272913283 -0.0 -1.6522100272913283
           -1.4590418232851277 -0.0 -0.0 -0.0 -1.4590418232851277 -0.0 -1.4590418232851277
           -1.4015111702500997 -0.0 -0.0 -0.0 -1.4015111702500997 -0.0 -1.4015111702500997
           -0.9738202253475602 -0.0 -0.0 -0.0 -0.9738202253475602 -0.0 -0.9738202253475602
           1.8091899079230156 0.0 0.0 0.0 1.8091899079230156 0.0 1.8091899079230156
           1.9274245415701026 0.0 0.0 0.0 1.9274245415701026 0.0 1.9274245415701026
           3.399094699981504 0.0 0.0 0.0 3.399094699981504 0.0 3.399094699981504
           6.157344170373497 0.0 0.0 0.0 6.157344170373497 0.0 6.157344170373497
           -1.5082203700488148 -0.0 -0.0 -0.0 -1.5082203700488148 -0.0 -0.0
           -0.7518968254083281 -0.0 -0.0 -0.0 -0.0 -0.7518968254083281 -0.0
           -1.403623374340758 -0.0 -0.0 -0.0 -0.0 -1.403623374340758 -0.0
           -1.5307566638052945 -0.0 -0.0 -0.0 -0.0 -1.5307566638052945 -0.0
           -1.6487615285777935 -0.0 -0.0 -0.0 -0.0 -1.6487615285777935 -0.0
           -1.5960112869101046 -0.0 -0.0 -0.0 -0.0 -1.5960112869101046 -0.0
           -1.3904968459197917 -0.0 -0.0 -0.0 -0.0 -1.3904968459197917 -0.0
           -0.8618818687491527 -0.0 -0.0 -0.0 -0.0 -0.8618818687491527 -0.0
           0.6414580291618693 0.0 0.0 0.0 0.0 0.6414580291618693 0.0
           1.0942097094869556 0.0 0.0 0.0 0.0 1.0942097094869556 0.0
           -1.7282583231217719 -1.7282583231217719 -1.7282583231217719 -0.0 -0.0 -0.0 -1.7282583231217719
           -0.31744768418403196 -0.31744768418403196 -0.31744768418403196 -0.0 -0.0 -0.0 -0.31744768418403196
           11.375280355235768 11.375280355235768 11.375280355235768 0.0 0.0 0.0 11.375280355235768
           -1.0256901959548927 -1.0256901959548927 -1.0256901959548927 -0.0 -0.0 -0.0 -0.0
           -1.0256901959548927 -1.0256901959548927 -1.0256901959548927 -0.0 -0.0 -0.0 -0.0
           -1.7598032161223125 -1.7598032161223125 -1.7598032161223125 -0.0 -0.0 -0.0 -0.0
           -1.491030768800334 -1.491030768800334 -1.491030768800334 -0.0 -0.0 -0.0 -0.0
           -0.7301769140610584 -0.7301769140610584 -0.7301769140610584 -0.0 -0.0 -0.0 -0.0
           -0.5034045168716083 -0.5034045168716083 -0.5034045168716083 -0.0 -0.0 -0.0 -0.0
           -1.113506915630734 -1.113506915630734 -1.113506915630734 -1.113506915630734 -0.0 -0.0 -1.113506915630734
           -1.113506915630734 -1.113506915630734 -1.113506915630734 -1.113506915630734 -0.0 -0.0 -1.113506915630734
           -1.6237007081122545 -1.6237007081122545 -1.6237007081122545 -1.6237007081122545 -0.0 -0.0 -1.6237007081122545
           -1.6237007081122545 -1.6237007081122545 -1.6237007081122545 -1.6237007081122545 -0.0 -0.0 -1.6237007081122545
           -1.6237007081122545 -1.6237007081122545 -1.6237007081122545 -1.6237007081122545 -0.0 -0.0 -1.6237007081122545
           -0.07026189294137537 -0.07026189294137537 -0.07026189294137537 -0.07026189294137537 -0.0 -0.0 -0.07026189294137537
           2.0844355685058127 2.0844355685058127 2.0844355685058127 2.0844355685058127 0.0 0.0 2.0844355685058127
           -1.7313903927438412 -1.7313903927438412 -1.7313903927438412 -1.7313903927438412 -0.0 -0.0 -0.0
           -1.480745232754872 -1.480745232754872 -1.480745232754872 -1.480745232754872 -0.0 -0.0 -0.0
           0.21539031393949493 0.21539031393949493 0.21539031393949493 0.0 0.21539031393949493 0.0 0.21539031393949493
           1.6360787089859707 1.6360787089859707 1.6360787089859707 0.0 1.6360787089859707 0.0 1.6360787089859707
           2.7952193074887086 2.7952193074887086 2.7952193074887086 0.0 2.7952193074887086 0.0 2.7952193074887086
           -1.448364418208364 -1.448364418208364 -1.448364418208364 -0.0 -1.448364418208364 -0.0 -0.0
           -0.9833503482488964 -0.9833503482488964 -0.9833503482488964 -0.0 -0.9833503482488964 -0.0 -0.0
           -1.5017276161539084 -1.5017276161539084 -1.5017276161539084 -0.0 -1.5017276161539084 -0.0 -0.0
           -1.7640356839137032 -1.7640356839137032 -1.7640356839137032 -0.0 -1.7640356839137032 -0.0 -0.0
           -1.5776069676233444 -1.5776069676233444 -1.5776069676233444 -0.0 -1.5776069676233444 -0.0 -0.0
           0.06361165131312438 0.06361165131312438 0.06361165131312438 0.0 0.06361165131312438 0.0 0.0
           2.8475608847598153 2.8475608847598153 2.8475608847598153 0.0 2.8475608847598153 0.0 0.0
           -0.8892460264142052 -0.8892460264142052 -0.8892460264142052 -0.0 -0.0 -0.8892460264142052 -0.0
           1.7743695974457907 1.7743695974457907 1.7743695974457907 0.0 0.0 1.7743695974457907 0.0
           -1.4305200814192562 -1.4305200814192562 -1.4305200814192562 -0.0 -0.0 -1.4305200814192562 -0.0
           -0.9478929479399423 -0.9478929479399423 -0.9478929479399423 -0.0 -0.0 -0.9478929479399423 -0.0
           1.2024302930353608 1.2024302930353608 1.2024302930353608 0.0 0.0 1.2024302930353608 0.0
           4.02280289664674 4.02280289664674 4.02280289664674 0.0 0.0 4.02280289664674 0.0
           10.440933185941839 10.440933185941839 10.440933185941839 0.0 0.0 10.440933185941839 0.0
           1.262517093518885 1.262517093518885 0.0 0.0 0.0 0.0 1.262517093518885
           -0.9176184029771589 -0.9176184029771589 -0.0 -0.0 -0.0 -0.0 -0.0
           -0.6982138187318754 -0.6982138187318754 -0.0 -0.0 -0.0 -0.0 -0.0
           1.7133696015602422 1.7133696015602422 0.0 0.0 0.0 0.0 0.0
           5.976953806399672 5.976953806399672 0.0 0.0 0.0 0.0 0.0
           -1.6123792319065735 -1.6123792319065735 -0.0 -1.6123792319065735 -0.0 -0.0 -1.6123792319065735
           -1.1866621929181271 -1.1866621929181271 -0.0 -1.1866621929181271 -0.0 -0.0 -1.1866621929181271
           -1.1194589330024307 -1.1194589330024307 -0.0 -1.1194589330024307 -0.0 -0.0 -1.1194589330024307
           -1.6605118926433484 -1.6605118926433484 -0.0 -1.6605118926433484 -0.0 -0.0 -1.6605118926433484
           -1.6123792319065735 -1.6123792319065735 -0.0 -1.6123792319065735 -0.0 -0.0 -1.6123792319065735
           -1.6123792319065735 -1.6123792319065735 -0.0 -1.6123792319065735 -0.0 -0.0 -1.6123792319065735
           -1.6123792319065735 -1.6123792319065735 -0.0 -1.6123792319065735 -0.0 -0.0 -1.6123792319065735
           -1.6123792319065735 -1.6123792319065735 -0.0 -1.6123792319065735 -0.0 -0.0 -1.6123792319065735
           -1.1866621929181271 -1.1866621929181271 -0.0 -1.1866621929181271 -0.0 -0.0 -1.1866621929181271
           -0.016084003453250676 -0.016084003453250676 -0.0 -0.016084003453250676 -0.0 -0.0 -0.016084003453250676
           1.4107278812149031 1.4107278812149031 0.0 1.4107278812149031 0.0 0.0 1.4107278812149031
           -1.1128985115655265 -1.1128985115655265 -0.0 -1.1128985115655265 -0.0 -0.0 -0.0
           3.7957001151581404 3.7957001151581404 0.0 3.7957001151581404 0.0 0.0 0.0
           -0.7046958095802869 -0.7046958095802869 -0.0 -0.7046958095802869 -0.0 -0.0 -0.0
           -0.7046958095802869 -0.7046958095802869 -0.0 -0.7046958095802869 -0.0 -0.0 -0.0
           -0.2475403067755282 -0.2475403067755282 -0.0 -0.2475403067755282 -0.0 -0.0 -0.0
           14.054845699928913 14.054845699928913 0.0 14.054845699928913 0.0 0.0 0.0
           -0.8850373634971601 -0.8850373634971601 -0.0 -0.0 -0.8850373634971601 -0.0 -0.8850373634971601
           -1.7594068536637126 -1.7594068536637126 -0.0 -0.0 -1.7594068536637126 -0.0 -1.7594068536637126
           -0.9681259531090506 -0.9681259531090506 -0.0 -0.0 -0.9681259531090506 -0.0 -0.9681259531090506
           -1.5970364987524888 -1.5970364987524888 -0.0 -0.0 -1.5970364987524888 -0.0 -1.5970364987524888
           -1.5970364987524888 -1.5970364987524888 -0.0 -0.0 -1.5970364987524888 -0.0 -1.5970364987524888
           -1.7082890535667876 -1.7082890535667876 -0.0 -0.0 -1.7082890535667876 -0.0 -1.7082890535667876
           -1.6168827210404924 -1.6168827210404924 -0.0 -0.0 -1.6168827210404924 -0.0 -1.6168827210404924
           -1.4399676449006795 -1.4399676449006795 -0.0 -0.0 -1.4399676449006795 -0.0 -1.4399676449006795
           -1.2202487676722908 -1.2202487676722908 -0.0 -0.0 -1.2202487676722908 -0.0 -1.2202487676722908
           -1.5079358693315765 -1.5079358693315765 -0.0 -0.0 -1.5079358693315765 -0.0 -0.0
           -1.3842064467607202 -1.3842064467607202 -0.0 -0.0 -0.0 -1.3842064467607202 -0.0
           -1.5208922216041325 -1.5208922216041325 -0.0 -0.0 -0.0 -1.5208922216041325 -0.0
           0.3453894161447818 0.3453894161447818 0.0 0.0 0.0 0.3453894161447818 0.0
           -1.717557999730545 -1.717557999730545 -0.0 -0.0 -0.0 -1.717557999730545 -0.0
           -1.717557999730545 -1.717557999730545 -0.0 -0.0 -0.0 -1.717557999730545 -0.0
           -1.76269912849327 -1.76269912849327 -0.0 -0.0 -0.0 -1.76269912849327 -0.0
           -0.7863622513628796 -0.7863622513628796 -0.0 -0.0 -0.0 -0.7863622513628796 -0.0
           -0.32795262618891574 -0.32795262618891574 -0.0 -0.0 -0.0 -0.32795262618891574 -0.0
           0.3453894161447818 0.3453894161447818 0.0 0.0 0.0 0.3453894161447818 0.0
           3.2758115948278728 3.2758115948278728 0.0 0.0 0.0 3.2758115948278728 0.0] rtol = 1e-04
end

admit_agr = DataFrame(count=[28.0, 97, 93, 55, 33, 54, 28, 12],
                      admit=repeat([false, true], inner=[4]),
                      rank=categorical(repeat(1:4, outer=2)))

@testset "Aggregated Binomial LogitLink (AnalyticWeights)" begin
    for distr in (Binomial, Bernoulli)
        gm14 = fit(GeneralizedLinearModel, @formula(admit ~ 1 + rank), admit_agr, distr(),
                   wts=aweights(admit_agr.count))
        @test dof(gm14) == 4
        @test nobs(gm14) == 8
        @test isapprox(deviance(gm14), 474.9667184280627)
        @test isapprox(coef(gm14),
                       [0.164303051291, -0.7500299832, -1.36469792994, -1.68672866457],
                       atol=1e-5)
        @test_throws ArgumentError loglikelihood(gm14)
        @test_throws ArgumentError aic(gm14)
        @test_throws ArgumentError aicc(gm14)
        @test_throws ArgumentError bic(gm14)
    end
end
